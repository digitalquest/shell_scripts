# Moodle dev/uat post process

Things to do after creating a dev/uat Moodle instance.
That particularly applies if you copied the database from a prod backup.
If it's not the case, you probably won't need to read this page.
 
We'll try to show different methods to 'post process' your instance:  
 - using moosh to prepare the Moodle dev/uat.
 - using the shell
 - using SQL
If moosh is not installed, and you want to use it, refer to their website or use the appendices below to install it.
With SQL client
 
    -- Set email address to black hole for all but moodl/trail accounts.

    UPDATE mdl_user
    SET email =  'nobody@ucl.ac.uk'
    WHERE id  NOT IN (
         SELECT A.id FROM mdl_user A
         WHERE A.username  LIKE 'moodl%' OR A.username  LIKE 'trail%'
    );
    Update 'SITS Filter 2' dependencies.
    To update dependent views in the appropriate moodle_sits_management_???2 database, execute the SQL which is generated by the following to recreate each of the views...
     
    SELECT
         TABLE_SCHEMA
       , TABLE_NAME
       , CONCAT( 'CREATE OR REPLACE VIEW ' , TABLE_SCHEMA,  '.' , TABLE_NAME,  ' AS ' ,
                REPLACE (VIEW_DEFINITION,  '`moodle_live`.' ,  '`moodle_devxxxx`.' ),  ';' )  AS sql_create
    FROM information_schema.VIEWS
    WHERE TABLE_SCHEMA =  'moodle_sits_management_dev2'
    AND VIEW_DEFINITION  LIKE '%`moodle_live`.%' ;

 
*Unlink google analytics*
**With SQL**
    UPDATE mdl_config_plugins  SET `value` = 0  WHERE `plugin` =  'theme_ucl' AND ` name ` =  'useanalytics' ;
    UPDATE mdl_config_plugins  SET `value` =  '' WHERE `plugin` =  'theme_ucl' AND ` name ` =  'analyticsid' ;
OR
**With moosh**
    moosh config-set useanalytics 0 theme_uc
    moosh config-set analyticsid UA-0000000-0 theme_ucl
 
**Set site name in Frontpage settings**
*Site administration >> Front page >> Front page settings*

*Set cookie prefix*
    moosh config-set sessioncookie ucl_devxxxxxx
    
OR

*Site administration >> Server >> Session handling*
 
    moosh config-set elluminate_server 'https://eu1.bbcollab.com/site/external/adapter/default/v3'
    moosh config-set elluminate_auth_username 'UCLEUMOODLETEST'
    moosh config-set elluminate_auth_password '<in KeePass>'
    
OR

    -- Set Blackboard Collaborate to use test account (details in KeePass).
    UPDATE mdl_config  SET `value` =  'https://eu1.bbcollab.com/site/external/adapter/default/v3'  WHERE ` name ` =  'elluminate_server' ;
    UPDATE mdl_config  SET `value` =  'UCLEUMOODLETEST' WHERE ` name ` =  'elluminate_auth_username' ;
    UPDATE mdl_config  SET `value` =  '<in KeePass>' WHERE ` name ` =  'elluminate_auth_password' ;
    
Global string replace (host URL).

    php admin/tool/replace/cli/replace.php --search=' https://moodle.ucl.ac.uk ' --replace='https://vxx.moodle-dev.ucl.ac.uk' --non-interactive
OR

https://moodle-snapshot.ucl.ac.uk/16-17/admin/tool/replace/
Search:  ' https://moodle.ucl.ac.uk ' 
Replace: 'https://vxx.moodle-dev.ucl.ac.uk'
 
**Changes to site settings:**
*Remove guest login button - settings->siteadmin->plugins->authentication->manage auth->login button=hide*
    moosh config-set guestloginbutton 0
 
*Security > Site policies > Site policy URL = http://moodle-archive.ucl.ac.uk/yy-yy/policy/about_the_archive.html (update yy with 10-11, 11-12 etc)*
    moosh config-set sitepolicy ''
    moosh config-set sitepolicyguest ''
 
Change cookie prefix to prevent session clashes (as more than one moodle instance on same server) : 
*admin->server->session handling*
    moosh config-set sessioncookie uclmoodle_devxxx
 
*mdl_course = set all guest access to 0 and all enrolment options to 0 – this disables all enrolments, guest functionality and student course ‘browsing’ *
    moosh config-set logguests 0
    moosh config-set allowguestmymoodle 0
    moosh config-set autologinguests 0 
    moosh config-set enrol_plugins_enabled ""
    moosh config-set allowunenroll 0
    moosh config-set allow_mass_enroll_feature 0 #just in case
 
2. Modify local_settings.php:
a. Change dbhost to 'moodle-snapshot.ucl.ac.uk'
    sed -i s/${OLD_HOST}/${NEW_HOST}/g local_settings.php
 
b. Change dbname to 'moodle_archive_1516'
    sed -i s/${OLD_DATABASE}/${NEW_DATABASE}/g local_settings.php
 
c. Change wwwroot to 'https://moodle-snapshot.ucl.ac.uk/15-16'
    sed -i s/${OLD_WWWROOT}/${NEW_WWWROOT}/g local_settings.php
 
d. Change dirroot to '/data/apache/htdocs/moodle'
    sed -i s/${OLD_DIRROOT}/${NEW_DIRROOT}/g local_settings.php
 
e. Change dataroot to '/data/moodle'
    sed -i s/${OLD_DATAROOT}/${NEW_DATAROOT}/g local_settings.php
 
3. Make other changes as required, especially noemailever = true.
    moosh config-set noemailever 1
 
Draft: to be reviwed/edited
    moosh config-set sessioncookie ucl_devxxxxxx
    moosh config-set sesskey ZJtr2016_17

    moosh config-set usepolicy '' theme_ucl
    moosh config-set marketing1image '' theme_ucl
    moosh config-set marketing2image '' theme_ucl
    moosh config-set marketing3image '' theme_ucl
    moosh config-set marketing4image '' theme_ucl
    moosh config-set accountid '<test account>' turnitintooltwo
    moosh config-set secretkey '<in KeePass>' turnitintooltwo
*With SQL*
    UPDATE mdl_config_plugins  SET `value` = ''  WHERE `plugin` =  'theme_ucl' AND ` name ` =  'usepolicy' ;
    UPDATE mdl_config_plugins  SET `value` =  '' WHERE `plugin` =  'theme_ucl' AND ` name ` =  'marketing1image' ;
    UPDATE mdl_config_plugins  SET `value` = ''  WHERE `plugin` =  'theme_ucl' AND ` name ` =  'marketing2image' ;
    UPDATE mdl_config_plugins  SET `value` =  '' WHERE `plugin` =  'theme_ucl' AND ` name ` =  'marketing3image' ;
    UPDATE mdl_config_plugins  SET `value` =  '' WHERE `plugin` =  'theme_ucl' AND ` name ` =  'marketing4image' ;
*from the command line
unset the history so that the password is not saved *
    unset HISTFILE
*edit as appropriate* 
    DB_USER='moodle_xxx' 
    DB_PASSWORD='<in keepass>' 
    DB_NAME='moodle_xxx'
    echo "UPDATE mdl_config_plugins SET `value` = '' WHERE `plugin` = 'theme_ucl' AND ` name ` = 'usepolicy' ;" | mysql -u $DB_USER -p${DB_PASSWORD} -v $DB_NAME
    echo "UPDATE mdl_config_plugins SET `value` = '' WHERE `plugin` = 'theme_ucl' AND ` name ` = 'marketing1image' ;" | mysql -u $DB_USER -p${DB_PASSWORD} -v $DB_NAME
    echo "UPDATE mdl_config_plugins SET `value` = '' WHERE `plugin` = 'theme_ucl' AND ` name ` = 'marketing2image' ;" | mysql -u $DB_USER -p${DB_PASSWORD} -v $DB_NAME
    echo "UPDATE mdl_config_plugins SET `value` = '' WHERE `plugin` = 'theme_ucl' AND ` name ` = 'marketing3image' ;" | mysql -u $DB_USER -p${DB_PASSWORD} -v $DB_NAME
    echo "UPDATE mdl_config_plugins SET `value` = '' WHERE `plugin` = 'theme_ucl' AND ` name ` = 'marketing4image' ;" | mysql -u $DB_USER -p${DB_PASSWORD} -v $DB_NAME
